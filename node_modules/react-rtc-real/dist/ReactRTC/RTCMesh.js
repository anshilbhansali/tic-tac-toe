"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _react = _interopRequireWildcard(require("react"));

var _RTCVideo = _interopRequireDefault(require("./RTCVideo.js"));

var _Form = _interopRequireDefault(require("./Form.js"));

var _Websocket = _interopRequireDefault(require("./Websocket.js"));

var _PeerConnection = _interopRequireDefault(require("./PeerConnection.js"));

var _constants = require("./functions/constants");

var _utils = require("./functions/utils");

require("core-js/stable");

require("regenerator-runtime");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function _getRequireWildcardCache() { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || _typeof(obj) !== "object" && typeof obj !== "function") { return { "default": obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj["default"] = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _typeof(obj) { if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

function asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(_next, _throw); } }

function _asyncToGenerator(fn) { return function () { var self = this, args = arguments; return new Promise(function (resolve, reject) { var gen = fn.apply(self, args); function _next(value) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "next", value); } function _throw(err) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "throw", err); } _next(undefined); }); }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

function _possibleConstructorReturn(self, call) { if (call && (_typeof(call) === "object" || typeof call === "function")) { return call; } return _assertThisInitialized(self); }

function _getPrototypeOf(o) { _getPrototypeOf = Object.setPrototypeOf ? Object.getPrototypeOf : function _getPrototypeOf(o) { return o.__proto__ || Object.getPrototypeOf(o); }; return _getPrototypeOf(o); }

function _assertThisInitialized(self) { if (self === void 0) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function"); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, writable: true, configurable: true } }); if (superClass) _setPrototypeOf(subClass, superClass); }

function _setPrototypeOf(o, p) { _setPrototypeOf = Object.setPrototypeOf || function _setPrototypeOf(o, p) { o.__proto__ = p; return o; }; return _setPrototypeOf(o, p); }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

var RTCMesh =
/*#__PURE__*/
function (_Component) {
  _inherits(RTCMesh, _Component);

  function RTCMesh(props) {
    var _this;

    _classCallCheck(this, RTCMesh);

    _this = _possibleConstructorReturn(this, _getPrototypeOf(RTCMesh).call(this, props));

    _defineProperty(_assertThisInitialized(_this), "openCamera",
    /*#__PURE__*/
    function () {
      var _ref = _asyncToGenerator(
      /*#__PURE__*/
      regeneratorRuntime.mark(function _callee(fromHandleOffer) {
        var _this$state, mediaConstraints, localMediaStream, mediaStream;

        return regeneratorRuntime.wrap(function _callee$(_context) {
          while (1) {
            switch (_context.prev = _context.next) {
              case 0:
                _this$state = _this.state, mediaConstraints = _this$state.mediaConstraints, localMediaStream = _this$state.localMediaStream;
                _context.prev = 1;

                if (localMediaStream) {
                  _context.next = 13;
                  break;
                }

                if (!_this.wantCamera) {
                  _context.next = 9;
                  break;
                }

                _context.next = 6;
                return navigator.mediaDevices.getUserMedia(mediaConstraints);

              case 6:
                mediaStream = _context.sent;
                _context.next = 12;
                break;

              case 9:
                _context.next = 11;
                return navigator.mediaDevices.getDisplayMedia(mediaConstraints);

              case 11:
                mediaStream = _context.sent;

              case 12:
                return _context.abrupt("return", fromHandleOffer === true ? mediaStream : _this.setState({
                  localMediaStream: mediaStream
                }));

              case 13:
                _context.next = 18;
                break;

              case 15:
                _context.prev = 15;
                _context.t0 = _context["catch"](1);
                console.error('getUserMedia Error: ', _context.t0);

              case 18:
              case "end":
                return _context.stop();
            }
          }
        }, _callee, null, [[1, 15]]);
      }));

      return function (_x) {
        return _ref.apply(this, arguments);
      };
    }());

    _defineProperty(_assertThisInitialized(_this), "handleOffer",
    /*#__PURE__*/
    function () {
      var _ref2 = _asyncToGenerator(
      /*#__PURE__*/
      regeneratorRuntime.mark(function _callee3(data) {
        var _this$state2, localMediaStream, roomKey, socketID, payload, mediaStream;

        return regeneratorRuntime.wrap(function _callee3$(_context3) {
          while (1) {
            switch (_context3.prev = _context3.next) {
              case 0:
                _this$state2 = _this.state, localMediaStream = _this$state2.localMediaStream, roomKey = _this$state2.roomKey, socketID = _this$state2.socketID;
                payload = data.payload;
                _context3.next = 4;
                return _this.rtcPeerConnection.setRemoteDescription(payload.message);

              case 4:
                mediaStream = localMediaStream;

                if (mediaStream) {
                  _context3.next = 9;
                  break;
                }

                _context3.next = 8;
                return _this.openCamera(true);

              case 8:
                mediaStream = _context3.sent;

              case 9:
                _this.setState({
                  connectionStarted: true,
                  localMediaStream: mediaStream
                },
                /*#__PURE__*/
                _asyncToGenerator(
                /*#__PURE__*/
                regeneratorRuntime.mark(function _callee2() {
                  var answer, payload, answerMessage;
                  return regeneratorRuntime.wrap(function _callee2$(_context2) {
                    while (1) {
                      switch (_context2.prev = _context2.next) {
                        case 0:
                          _context2.next = 2;
                          return this.rtcPeerConnection.createAnswer();

                        case 2:
                          answer = _context2.sent;
                          _context2.next = 5;
                          return this.rtcPeerConnection.setLocalDescription(answer);

                        case 5:
                          payload = (0, _utils.createPayload)(roomKey, socketID, answer);
                          answerMessage = (0, _utils.createMessage)(_constants.TYPE_ANSWER, payload);
                          this.socket.send(JSON.stringify(answerMessage));

                        case 8:
                        case "end":
                          return _context2.stop();
                      }
                    }
                  }, _callee2, this);
                })));

              case 10:
              case "end":
                return _context3.stop();
            }
          }
        }, _callee3);
      }));

      return function (_x2) {
        return _ref2.apply(this, arguments);
      };
    }());

    _defineProperty(_assertThisInitialized(_this), "handleAnswer",
    /*#__PURE__*/
    function () {
      var _ref4 = _asyncToGenerator(
      /*#__PURE__*/
      regeneratorRuntime.mark(function _callee4(data) {
        var payload;
        return regeneratorRuntime.wrap(function _callee4$(_context4) {
          while (1) {
            switch (_context4.prev = _context4.next) {
              case 0:
                payload = data.payload;
                _context4.next = 3;
                return _this.rtcPeerConnection.setRemoteDescription(payload.message);

              case 3:
              case "end":
                return _context4.stop();
            }
          }
        }, _callee4);
      }));

      return function (_x3) {
        return _ref4.apply(this, arguments);
      };
    }());

    _defineProperty(_assertThisInitialized(_this), "handleIceCandidate",
    /*#__PURE__*/
    function () {
      var _ref5 = _asyncToGenerator(
      /*#__PURE__*/
      regeneratorRuntime.mark(function _callee5(data) {
        var message, candidate;
        return regeneratorRuntime.wrap(function _callee5$(_context5) {
          while (1) {
            switch (_context5.prev = _context5.next) {
              case 0:
                message = data.payload.message;
                candidate = JSON.parse(message);
                _context5.next = 4;
                return _this.rtcPeerConnection.addIceCandidate(candidate);

              case 4:
              case "end":
                return _context5.stop();
            }
          }
        }, _callee5);
      }));

      return function (_x4) {
        return _ref5.apply(this, arguments);
      };
    }());

    _defineProperty(_assertThisInitialized(_this), "handleShareDisplay",
    /*#__PURE__*/
    _asyncToGenerator(
    /*#__PURE__*/
    regeneratorRuntime.mark(function _callee6() {
      var _this$state3, mediaConstraints, localMediaStream, mediaStream, screenStream, transceiver;

      return regeneratorRuntime.wrap(function _callee6$(_context6) {
        while (1) {
          switch (_context6.prev = _context6.next) {
            case 0:
              _this.wantCamera = !_this.wantCamera;

              if (!_this.state.connectionStarted) {
                _context6.next = 17;
                break;
              }

              _this$state3 = _this.state, mediaConstraints = _this$state3.mediaConstraints, localMediaStream = _this$state3.localMediaStream;

              if (!_this.wantCamera) {
                _context6.next = 9;
                break;
              }

              _context6.next = 6;
              return navigator.mediaDevices.getUserMedia(mediaConstraints);

            case 6:
              mediaStream = _context6.sent;
              _context6.next = 12;
              break;

            case 9:
              _context6.next = 11;
              return navigator.mediaDevices.getDisplayMedia(mediaConstraints);

            case 11:
              mediaStream = _context6.sent;

            case 12:
              screenStream = mediaStream.getVideoTracks()[0];
              transceiver = _this.rtcPeerConnection.getTransceivers()[0];
              localMediaStream.removeTrack(localMediaStream.getTracks()[0]);
              localMediaStream.addTrack(screenStream);
              transceiver['sender'].replaceTrack(screenStream);

            case 17:
            case "end":
              return _context6.stop();
          }
        }
      }, _callee6);
    })));

    _defineProperty(_assertThisInitialized(_this), "sendRoomKey", function () {
      var _this$state4 = _this.state,
          roomKey = _this$state4.roomKey,
          socketID = _this$state4.socketID;

      if (!roomKey) {
        var key = (0, _utils.generateRoomKey)();
        var roomData = (0, _utils.createMessage)(_constants.TYPE_ROOM, (0, _utils.createPayload)(key, socketID));

        _this.setState({
          roomKey: key
        });

        _this.socket.send(JSON.stringify(roomData));

        alert(key);
      }
    });

    _defineProperty(_assertThisInitialized(_this), "handleSocketConnection", function (socketID) {
      _this.setState({
        socketID: socketID
      });
    });

    _defineProperty(_assertThisInitialized(_this), "handleConnectionReady", function (message) {
      console.log('Inside handleConnectionReady: ', message);

      if (message.startConnection) {
        _this.setState({
          connectionStarted: message.startConnection
        });
      }
    });

    _defineProperty(_assertThisInitialized(_this), "addRemoteStream", function (remoteMediaStream) {
      _this.setState({
        remoteMediaStream: remoteMediaStream
      });
    });

    _defineProperty(_assertThisInitialized(_this), "handleSubmit", function (event) {
      event.preventDefault();
      var _this$state5 = _this.state,
          text = _this$state5.text,
          socketID = _this$state5.socketID; // send the roomKey
      // Remove leading and trailing whitespace

      if (text.trim()) {
        var roomKeyMessage = (0, _utils.createMessage)(_constants.TYPE_ROOM, (0, _utils.createPayload)(text, socketID));

        _this.socket.send(JSON.stringify(roomKeyMessage));
      }

      ;

      _this.setState({
        text: '',
        roomKey: text.trim()
      });
    });

    _defineProperty(_assertThisInitialized(_this), "handleChange", function (event) {
      _this.setState({
        text: event.target.value
      });
    });

    var _mediaConstraints = props.mediaConstraints,
        iceServers = props.iceServers,
        URL = props.URL; // build iceServers config for RTCPeerConnection

    var iceServerURLs = (0, _utils.buildServers)(iceServers);
    _this.state = {
      iceServers: iceServerURLs || _constants.DEFAULT_ICE_SERVERS,
      mediaConstraints: _mediaConstraints || _constants.DEFAULT_CONSTRAINTS,
      localMediaStream: null,
      remoteMediaStream: null,
      roomKey: null,
      socketID: null,
      connectionStarted: false,
      text: ''
    };
    _this.wantCamera = true;
    _this.socket = new WebSocket(_this.props.URL);
    _this.rtcPeerConnection = new RTCPeerConnection({
      iceServers: _this.state.iceServers
    });
    return _this;
  }

  _createClass(RTCMesh, [{
    key: "render",
    value: function render() {
      var _this$state6 = this.state,
          localMediaStream = _this$state6.localMediaStream,
          remoteMediaStream = _this$state6.remoteMediaStream,
          text = _this$state6.text,
          roomKey = _this$state6.roomKey,
          socketID = _this$state6.socketID,
          iceServers = _this$state6.iceServers,
          connectionStarted = _this$state6.connectionStarted;
      var sendMessage = this.socket.send.bind(this.socket);
      return _react["default"].createElement(_react["default"].Fragment, null, _react["default"].createElement(_Websocket["default"], {
        socket: this.socket,
        setSendMethod: this.setSendMethod,
        handleSocketConnection: this.handleSocketConnection,
        handleConnectionReady: this.handleConnectionReady,
        handleOffer: this.handleOffer,
        handleAnswer: this.handleAnswer,
        handleIceCandidate: this.handleIceCandidate
      }), _react["default"].createElement(_PeerConnection["default"], {
        rtcPeerConnection: this.rtcPeerConnection,
        iceServers: iceServers,
        localMediaStream: localMediaStream,
        addRemoteStream: this.addRemoteStream,
        startConnection: connectionStarted,
        sendMessage: sendMessage,
        roomInfo: {
          socketID: socketID,
          roomKey: roomKey
        }
      }), _react["default"].createElement(_RTCVideo["default"], {
        mediaStream: localMediaStream
      }), _react["default"].createElement(_RTCVideo["default"], {
        mediaStream: remoteMediaStream
      }), _react["default"].createElement(_Form["default"], {
        handleSubmit: this.handleSubmit,
        handleChange: this.handleChange,
        hasRoomKey: roomKey,
        text: text
      }), _react["default"].createElement("section", {
        className: "button-container"
      }, _react["default"].createElement("div", {
        className: "button button--start-color",
        onClick: this.openCamera
      }), _react["default"].createElement("button", {
        onClick: this.handleShareDisplay
      }, "Share Screen"), _react["default"].createElement("div", {
        className: "button button--stop-color",
        onClick: null
      })));
    }
  }]);

  return RTCMesh;
}(_react.Component);

var _default = RTCMesh;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9SZWFjdFJUQy9SVENNZXNoLmpzeCJdLCJuYW1lcyI6WyJSVENNZXNoIiwicHJvcHMiLCJmcm9tSGFuZGxlT2ZmZXIiLCJzdGF0ZSIsIm1lZGlhQ29uc3RyYWludHMiLCJsb2NhbE1lZGlhU3RyZWFtIiwid2FudENhbWVyYSIsIm5hdmlnYXRvciIsIm1lZGlhRGV2aWNlcyIsImdldFVzZXJNZWRpYSIsIm1lZGlhU3RyZWFtIiwiZ2V0RGlzcGxheU1lZGlhIiwic2V0U3RhdGUiLCJjb25zb2xlIiwiZXJyb3IiLCJkYXRhIiwicm9vbUtleSIsInNvY2tldElEIiwicGF5bG9hZCIsInJ0Y1BlZXJDb25uZWN0aW9uIiwic2V0UmVtb3RlRGVzY3JpcHRpb24iLCJtZXNzYWdlIiwib3BlbkNhbWVyYSIsImNvbm5lY3Rpb25TdGFydGVkIiwiY3JlYXRlQW5zd2VyIiwiYW5zd2VyIiwic2V0TG9jYWxEZXNjcmlwdGlvbiIsImFuc3dlck1lc3NhZ2UiLCJUWVBFX0FOU1dFUiIsInNvY2tldCIsInNlbmQiLCJKU09OIiwic3RyaW5naWZ5IiwiY2FuZGlkYXRlIiwicGFyc2UiLCJhZGRJY2VDYW5kaWRhdGUiLCJzY3JlZW5TdHJlYW0iLCJnZXRWaWRlb1RyYWNrcyIsInRyYW5zY2VpdmVyIiwiZ2V0VHJhbnNjZWl2ZXJzIiwicmVtb3ZlVHJhY2siLCJnZXRUcmFja3MiLCJhZGRUcmFjayIsInJlcGxhY2VUcmFjayIsImtleSIsInJvb21EYXRhIiwiVFlQRV9ST09NIiwiYWxlcnQiLCJsb2ciLCJzdGFydENvbm5lY3Rpb24iLCJyZW1vdGVNZWRpYVN0cmVhbSIsImV2ZW50IiwicHJldmVudERlZmF1bHQiLCJ0ZXh0IiwidHJpbSIsInJvb21LZXlNZXNzYWdlIiwidGFyZ2V0IiwidmFsdWUiLCJpY2VTZXJ2ZXJzIiwiVVJMIiwiaWNlU2VydmVyVVJMcyIsIkRFRkFVTFRfSUNFX1NFUlZFUlMiLCJERUZBVUxUX0NPTlNUUkFJTlRTIiwiV2ViU29ja2V0IiwiUlRDUGVlckNvbm5lY3Rpb24iLCJzZW5kTWVzc2FnZSIsImJpbmQiLCJzZXRTZW5kTWV0aG9kIiwiaGFuZGxlU29ja2V0Q29ubmVjdGlvbiIsImhhbmRsZUNvbm5lY3Rpb25SZWFkeSIsImhhbmRsZU9mZmVyIiwiaGFuZGxlQW5zd2VyIiwiaGFuZGxlSWNlQ2FuZGlkYXRlIiwiYWRkUmVtb3RlU3RyZWFtIiwiaGFuZGxlU3VibWl0IiwiaGFuZGxlQ2hhbmdlIiwiaGFuZGxlU2hhcmVEaXNwbGF5IiwiQ29tcG9uZW50Il0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0lBRU1BLE87Ozs7O0FBQ0osbUJBQVlDLEtBQVosRUFBbUI7QUFBQTs7QUFBQTs7QUFDakIsaUZBQU1BLEtBQU47O0FBRGlCO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQSw4QkFvQk4saUJBQU9DLGVBQVA7QUFBQTs7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBLDhCQUNvQyxNQUFLQyxLQUR6QyxFQUNIQyxnQkFERyxlQUNIQSxnQkFERyxFQUNlQyxnQkFEZixlQUNlQSxnQkFEZjtBQUFBOztBQUFBLG9CQUdKQSxnQkFISTtBQUFBO0FBQUE7QUFBQTs7QUFBQSxxQkFLSixNQUFLQyxVQUxEO0FBQUE7QUFBQTtBQUFBOztBQUFBO0FBQUEsdUJBS2lDQyxTQUFTLENBQUNDLFlBQVYsQ0FBdUJDLFlBQXZCLENBQW9DTCxnQkFBcEMsQ0FMakM7O0FBQUE7QUFLYU0sZ0JBQUFBLFdBTGI7QUFBQTtBQUFBOztBQUFBO0FBQUE7QUFBQSx1QkFNa0JILFNBQVMsQ0FBQ0MsWUFBVixDQUF1QkcsZUFBdkIsQ0FBdUNQLGdCQUF2QyxDQU5sQjs7QUFBQTtBQU1GTSxnQkFBQUEsV0FORTs7QUFBQTtBQUFBLGlEQVFBUixlQUFlLEtBQUssSUFBcEIsR0FBMkJRLFdBQTNCLEdBQXlDLE1BQUtFLFFBQUwsQ0FBYztB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LGVBQWUsRUFBRWxELGlCQUxuQjtBQU1FLFFBQUEsV0FBVyxFQUFFMEMsV0FOZjtBQU9FLFFBQUEsUUFBUSxFQUFFO0FBQUVoRCxVQUFBQSxRQUFRLEVBQVJBLFFBQUY7QUFBWUQsVUFBQUEsT0FBTyxFQUFQQTtBQUFaO0FBUFosUUFWRixFQW1CRSxnQ0FBQyxvQkFBRDtBQUFVLFFBQUEsV0FBVyxFQUFFWDtBQUF2QixRQW5CRixFQW9CRSxnQ0FBQyxvQkFBRDtBQUFVLFFBQUEsV0FBVyxFQUFFNkM7QUFBdkIsUUFwQkYsRUFzQkUsZ0NBQUMsZ0JBQUQ7QUFDRSxRQUFBLFlBQVksRUFBRSxLQUFLd0IsWUFEckI7QUFFRSxRQUFBLFlBQVksRUFBRSxLQUFLQyxZQUZyQjtBQUdFLFFBQUEsVUFBVSxFQUFFM0QsT0FIZDtBQUlFLFFBQUEsSUFBSSxFQUFFcUM7QUFKUixRQXRCRixFQTZCRTtBQUFTLFFBQUEsU0FBUyxFQUFDO0FBQW5CLFNBQ0U7QUFBSyxRQUFBLFNBQVMsRUFBQyw0QkFBZjtBQUE0QyxRQUFBLE9BQU8sRUFBRSxLQUFLL0I7QUFBMUQsUUFERixFQUdFO0FBQVEsUUFBQSxPQUFPLEVBQUUsS0FBS3NEO0FBQXRCLHdCQUhGLEVBSUU7QUFBSyxRQUFBLFNBQVMsRUFBQywyQkFBZjtBQUEyQyxRQUFBLE9BQU8sRUFBRTtBQUFwRCxRQUpGLENBN0JGLENBREY7QUF1Q0Q7Ozs7RUE3S21CQyxnQjs7ZUFnTFA3RSxPIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlYWN0LCB7IENvbXBvbmVudCB9IGZyb20gJ3JlYWN0JztcbmltcG9ydCBSVENWaWRlbyBmcm9tICcuL1JUQ1ZpZGVvLmpzJztcbmltcG9ydCBGb3JtIGZyb20gJy4vRm9ybS5qcyc7XG5pbXBvcnQgV2Vic29ja2V0IGZyb20gJy4vV2Vic29ja2V0LmpzJztcbmltcG9ydCBQZWVyQ29ubmVjdGlvbiBmcm9tICcuL1BlZXJDb25uZWN0aW9uLmpzJztcbmltcG9ydCB7IERFRkFVTFRfQ09OU1RSQUlOVFMsIERFRkFVTFRfSUNFX1NFUlZFUlMsIFRZUEVfUk9PTSwgVFlQRV9BTlNXRVIgfSBmcm9tICcuL2Z1bmN0aW9ucy9jb25zdGFudHMnO1xuaW1wb3J0IHsgYnVpbGRTZXJ2ZXJzLCBnZW5lcmF0ZVJvb21LZXksIGNyZWF0ZU1lc3NhZ2UsIGNyZWF0ZVBheWxvYWQgfSBmcm9tICcuL2Z1bmN0aW9ucy91dGlscyc7XG5pbXBvcnQgJ2NvcmUtanMvc3RhYmxlJztcbmltcG9ydCAncmVnZW5lcmF0b3ItcnVudGltZSdcblxuY2xhc3MgUlRDTWVzaCBleHRlbmRzIENvbXBvbmVudCB7XG4gIGNvbnN0cnVjdG9yKHByb3BzKSB7XG4gICAgc3VwZXIocHJvcHMpO1xuICAgIGNvbnN0IHttZWRpYUNvbnN0cmFpbnRzLCBpY2VTZXJ2ZXJzLCBVUkwgfSA9IHByb3BzO1xuICAgIC8vIGJ1aWxkIGljZVNlcnZlcnMgY29uZmlnIGZvciBSVENQZWVyQ29ubmVjdGlvblxuICAgIGNvbnN0IGljZVNlcnZlclVSTHMgPSBidWlsZFNlcnZlcnMoaWNlU2VydmVycyk7XG4gICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgIGljZVNlcnZlcnM6IGljZVNlcnZlclVSTHMgfHwgREVGQVVMVF9JQ0VfU0VSVkVSUyxcbiAgICAgIG1lZGlhQ29uc3RyYWludHM6IG1lZGlhQ29uc3RyYWludHMgfHwgREVGQVVMVF9DT05TVFJBSU5UUyxcbiAgICAgIGxvY2FsTWVkaWFTdHJlYW06IG51bGwsXG4gICAgICByZW1vdGVNZWRpYVN0cmVhbTogbnVsbCxcbiAgICAgIHJvb21LZXk6IG51bGwsXG4gICAgICBzb2NrZXRJRDogbnVsbCxcbiAgICAgIGNvbm5lY3Rpb25TdGFydGVkOiBmYWxzZSxcbiAgICAgIHRleHQ6ICcnXG4gICAgfTtcbiAgICB0aGlzLndhbnRDYW1lcmEgPSB0cnVlO1xuICAgIHRoaXMuc29ja2V0ID0gbmV3IFdlYlNvY2tldCh0aGlzLnByb3BzLlVSTCk7XG4gICAgdGhpcy5ydGNQZWVyQ29ubmVjdGlvbiA9IG5ldyBSVENQZWVyQ29ubmVjdGlvbih7IGljZVNlcnZlcnM6IHRoaXMuc3RhdGUuaWNlU2VydmVycyB9KTtcbiAgfVxuXG4gIG9wZW5DYW1lcmEgPSBhc3luYyAoZnJvbUhhbmRsZU9mZmVyKSA9PiB7XG4gICAgY29uc3QgeyBtZWRpYUNvbnN0cmFpbnRzLCBsb2NhbE1lZGlhU3RyZWFtIH0gPSB0aGlzLnN0YXRlO1xuICAgIHRyeSB7XG4gICAgICBpZiAoIWxvY2FsTWVkaWFTdHJlYW0pIHtcbiAgICAgICAgbGV0IG1lZGlhU3RyZWFtO1xuICAgICAgICBpZih0aGlzLndhbnRDYW1lcmEpIG1lZGlhU3RyZWFtID0gYXdhaXQgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5nZXRVc2VyTWVkaWEobWVkaWFDb25zdHJhaW50cyk7XG4gICAgICAgIGVsc2UgbWVkaWFTdHJlYW0gPSBhd2FpdCBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmdldERpc3BsYXlNZWRpYShtZWRpYUNvbnN0cmFpbnRzKTtcbiAgICAgICAgXG4gICAgICAgIHJldHVybiBmcm9tSGFuZGxlT2ZmZXIgPT09IHRydWUgPyBtZWRpYVN0cmVhbSA6IHRoaXMuc2V0U3RhdGUoeyBsb2NhbE1lZGlhU3RyZWFtOiBtZWRpYVN0cmVhbSB9KTtcbiAgICAgIH1cbiAgICB9IGNhdGNoKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdnZXRVc2VyTWVkaWEgRXJyb3I6ICcsIGVycm9yKVxuICAgIH1cbiAgfVxuXG4gIGhhbmRsZU9mZmVyID0gYXN5bmMgKGRhdGEpID0+IHtcbiAgICBjb25zdCB7IGxvY2FsTWVkaWFTdHJlYW0sIHJvb21LZXksIHNvY2tldElEIH0gPSB0aGlzLnN0YXRlO1xuICAgIGNvbnN0IHsgcGF5bG9hZCB9ID0gZGF0YTtcbiAgICBhd2FpdCB0aGlzLnJ0Y1BlZXJDb25uZWN0aW9uLnNldFJlbW90ZURlc2NyaXB0aW9uKHBheWxvYWQubWVzc2FnZSk7XG4gICAgbGV0IG1lZGlhU3RyZWFtID0gbG9jYWxNZWRpYVN0cmVhbVxuICAgIGlmICghbWVkaWFTdHJlYW0pIG1lZGlhU3RyZWFtID0gYXdhaXQgdGhpcy5vcGVuQ2FtZXJhKHRydWUpO1xuICAgIHRoaXMuc2V0U3RhdGUoeyBjb25uZWN0aW9uU3RhcnRlZDogdHJ1ZSwgbG9jYWxNZWRpYVN0cmVhbTogbWVkaWFTdHJlYW0gfSwgYXN5bmMgZnVuY3Rpb24oKSB7XG4gICAgICBjb25zdCBhbnN3ZXIgPSBhd2FpdCB0aGlzLnJ0Y1BlZXJDb25uZWN0aW9uLmNyZWF0ZUFuc3dlcigpO1xuICAgICAgYXdhaXQgdGhpcy5ydGNQZWVyQ29ubmVjdGlvbi5zZXRMb2NhbERlc2NyaXB0aW9uKGFuc3dlcik7XG4gICAgICBjb25zdCBwYXlsb2FkID0gY3JlYXRlUGF5bG9hZChyb29tS2V5LCBzb2NrZXRJRCwgYW5zd2VyKTtcbiAgICAgIGNvbnN0IGFuc3dlck1lc3NhZ2UgPSBjcmVhdGVNZXNzYWdlKFRZUEVfQU5TV0VSLCBwYXlsb2FkKTtcbiAgICAgIHRoaXMuc29ja2V0LnNlbmQoSlNPTi5zdHJpbmdpZnkoYW5zd2VyTWVzc2FnZSkpO1xuICAgIH0pO1xuICB9XG5cbiAgaGFuZGxlQW5zd2VyID0gYXN5bmMgKGRhdGEpID0+IHtcbiAgICBjb25zdCB7IHBheWxvYWQgfSA9IGRhdGE7XG4gICAgYXdhaXQgdGhpcy5ydGNQZWVyQ29ubmVjdGlvbi5zZXRSZW1vdGVEZXNjcmlwdGlvbihwYXlsb2FkLm1lc3NhZ2UpO1xuICB9XG5cbiAgaGFuZGxlSWNlQ2FuZGlkYXRlID0gYXN5bmMgKGRhdGEpID0+IHtcbiAgICBjb25zdCB7IG1lc3NhZ2UgfSA9IGRhdGEucGF5bG9hZDtcbiAgICBjb25zdCBjYW5kaWRhdGUgPSBKU09OLnBhcnNlKG1lc3NhZ2UpO1xuICAgIGF3YWl0IHRoaXMucnRjUGVlckNvbm5lY3Rpb24uYWRkSWNlQ2FuZGlkYXRlKGNhbmRpZGF0ZSk7XG4gIH1cblxuICBoYW5kbGVTaGFyZURpc3BsYXkgPSBhc3luYygpID0+IHtcbiAgICB0aGlzLndhbnRDYW1lcmEgPSAhdGhpcy53YW50Q2FtZXJhXG4gICAgaWYodGhpcy5zdGF0ZS5jb25uZWN0aW9uU3RhcnRlZCl7XG4gICAgICBjb25zdCB7IG1lZGlhQ29uc3RyYWludHMsIGxvY2FsTWVkaWFTdHJlYW0gfSA9IHRoaXMuc3RhdGU7XG4gICAgICBsZXQgbWVkaWFTdHJlYW07XG4gICAgICBpZih0aGlzLndhbnRDYW1lcmEpIG1lZGlhU3RyZWFtID0gYXdhaXQgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5nZXRVc2VyTWVkaWEobWVkaWFDb25zdHJhaW50cylcbiAgICAgIGVsc2UgbWVkaWFTdHJlYW0gPSBhd2FpdCBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmdldERpc3BsYXlNZWRpYShtZWRpYUNvbnN0cmFpbnRzKVxuICAgICAgXG4gICAgICBsZXQgc2NyZWVuU3RyZWFtID0gbWVkaWFTdHJlYW0uZ2V0VmlkZW9UcmFja3MoKVswXVxuICAgICAgY29uc3QgdHJhbnNjZWl2ZXIgPSB0aGlzLnJ0Y1BlZXJDb25uZWN0aW9uLmdldFRyYW5zY2VpdmVycygpWzBdXG4gICAgICBsb2NhbE1lZGlhU3RyZWFtLnJlbW92ZVRyYWNrKGxvY2FsTWVkaWFTdHJlYW0uZ2V0VHJhY2tzKClbMF0pXG4gICAgICBsb2NhbE1lZGlhU3RyZWFtLmFkZFRyYWNrKHNjcmVlblN0cmVhbSlcbiAgICAgIHRyYW5zY2VpdmVyWydzZW5kZXInXS5yZXBsYWNlVHJhY2soc2NyZWVuU3RyZWFtKSAgXG4gICAgfVxuICB9XG5cbiAgc2VuZFJvb21LZXkgPSAoKSA9PiB7XG4gICAgY29uc3QgeyByb29tS2V5LCBzb2NrZXRJRCB9ID0gdGhpcy5zdGF0ZTtcbiAgICBpZiAoIXJvb21LZXkpIHtcbiAgICAgIGNvbnN0IGtleSA9IGdlbmVyYXRlUm9vbUtleSgpO1xuICAgICAgY29uc3Qgcm9vbURhdGEgPSBjcmVhdGVNZXNzYWdlKFRZUEVfUk9PTSwgY3JlYXRlUGF5bG9hZChrZXksIHNvY2tldElEKSk7XG4gICAgICB0aGlzLnNldFN0YXRlKHsgcm9vbUtleToga2V5IH0pXG4gICAgICB0aGlzLnNvY2tldC5zZW5kKEpTT04uc3RyaW5naWZ5KHJvb21EYXRhKSk7XG4gICAgICBhbGVydChrZXkpO1xuICAgIH1cbiAgfVxuXG4gIGhhbmRsZVNvY2tldENvbm5lY3Rpb24gPSAoc29ja2V0SUQpID0+IHtcbiAgICB0aGlzLnNldFN0YXRlKHsgc29ja2V0SUQgfSk7XG4gIH1cblxuICBoYW5kbGVDb25uZWN0aW9uUmVhZHkgPSAobWVzc2FnZSkgPT4ge1xuICAgIGNvbnNvbGUubG9nKCdJbnNpZGUgaGFuZGxlQ29ubmVjdGlvblJlYWR5OiAnLCBtZXNzYWdlKTtcbiAgICBpZiAobWVzc2FnZS5zdGFydENvbm5lY3Rpb24pIHtcbiAgICAgIHRoaXMuc2V0U3RhdGUoeyBjb25uZWN0aW9uU3RhcnRlZDogbWVzc2FnZS5zdGFydENvbm5lY3Rpb24gfSk7XG4gICAgfVxuICB9XG5cbiAgYWRkUmVtb3RlU3RyZWFtID0gKHJlbW90ZU1lZGlhU3RyZWFtKSA9PiB7XG4gICAgdGhpcy5zZXRTdGF0ZSh7IHJlbW90ZU1lZGlhU3RyZWFtIH0pO1xuICB9XG5cbiAgaGFuZGxlU3VibWl0ID0gKGV2ZW50KSA9PiB7XG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICBjb25zdCB7IHRleHQsIHNvY2tldElEIH0gPSB0aGlzLnN0YXRlO1xuICAgIC8vIHNlbmQgdGhlIHJvb21LZXlcbiAgICAvLyBSZW1vdmUgbGVhZGluZyBhbmQgdHJhaWxpbmcgd2hpdGVzcGFjZVxuICAgIGlmICh0ZXh0LnRyaW0oKSkge1xuICAgICAgY29uc3Qgcm9vbUtleU1lc3NhZ2UgPSBjcmVhdGVNZXNzYWdlKFRZUEVfUk9PTSwgY3JlYXRlUGF5bG9hZCh0ZXh0LCBzb2NrZXRJRCkpO1xuICAgICAgdGhpcy5zb2NrZXQuc2VuZChKU09OLnN0cmluZ2lmeShyb29tS2V5TWVzc2FnZSkpO1xuICAgIH07XG4gICAgdGhpcy5zZXRTdGF0ZSh7IHRleHQ6ICcnLCByb29tS2V5OiB0ZXh0LnRyaW0oKSB9KTtcbiAgfVxuXG4gIGhhbmRsZUNoYW5nZSA9IChldmVudCkgPT4ge1xuICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgdGV4dDogZXZlbnQudGFyZ2V0LnZhbHVlXG4gICAgfSk7XG4gIH1cblxuICByZW5kZXIoKSB7XG4gICAgY29uc3QgeyBcbiAgICAgIGxvY2FsTWVkaWFTdHJlYW0sXG4gICAgICByZW1vdGVNZWRpYVN0cmVhbSxcbiAgICAgIHRleHQsXG4gICAgICByb29tS2V5LFxuICAgICAgc29ja2V0SUQsXG4gICAgICBpY2VTZXJ2ZXJzLFxuICAgICAgY29ubmVjdGlvblN0YXJ0ZWQsXG4gICAgfSA9IHRoaXMuc3RhdGU7XG4gICAgY29uc3Qgc2VuZE1lc3NhZ2UgPSB0aGlzLnNvY2tldC5zZW5kLmJpbmQodGhpcy5zb2NrZXQpO1xuXG4gICAgcmV0dXJuIChcbiAgICAgIDw+XG4gICAgICAgIDxXZWJzb2NrZXQgXG4gICAgICAgICAgc29ja2V0PXt0aGlzLnNvY2tldH1cbiAgICAgICAgICBzZXRTZW5kTWV0aG9kPXt0aGlzLnNldFNlbmRNZXRob2R9XG4gICAgICAgICAgaGFuZGxlU29ja2V0Q29ubmVjdGlvbj17dGhpcy5oYW5kbGVTb2NrZXRDb25uZWN0aW9ufVxuICAgICAgICAgIGhhbmRsZUNvbm5lY3Rpb25SZWFkeT17dGhpcy5oYW5kbGVDb25uZWN0aW9uUmVhZHl9XG4gICAgICAgICAgaGFuZGxlT2ZmZXI9e3RoaXMuaGFuZGxlT2ZmZXJ9XG4gICAgICAgICAgaGFuZGxlQW5zd2VyPXt0aGlzLmhhbmRsZUFuc3dlcn1cbiAgICAgICAgICBoYW5kbGVJY2VDYW5kaWRhdGU9e3RoaXMuaGFuZGxlSWNlQ2FuZGlkYXRlfVxuICAgICAgICAvPlxuICAgICAgICA8UGVlckNvbm5lY3Rpb25cbiAgICAgICAgICBydGNQZWVyQ29ubmVjdGlvbj17dGhpcy5ydGNQZWVyQ29ubmVjdGlvbn1cbiAgICAgICAgICBpY2VTZXJ2ZXJzPXtpY2VTZXJ2ZXJzfVxuICAgICAgICAgIGxvY2FsTWVkaWFTdHJlYW09e2xvY2FsTWVkaWFTdHJlYW19XG4gICAgICAgICAgYWRkUmVtb3RlU3RyZWFtPXt0aGlzLmFkZFJlbW90ZVN0cmVhbX1cbiAgICAgICAgICBzdGFydENvbm5lY3Rpb249e2Nvbm5lY3Rpb25TdGFydGVkfVxuICAgICAgICAgIHNlbmRNZXNzYWdlPXtzZW5kTWVzc2FnZX1cbiAgICAgICAgICByb29tSW5mbz17eyBzb2NrZXRJRCwgcm9vbUtleSB9fVxuICAgICAgICAvPlxuICAgICAgICA8UlRDVmlkZW8gbWVkaWFTdHJlYW09e2xvY2FsTWVkaWFTdHJlYW19IC8+XG4gICAgICAgIDxSVENWaWRlbyBtZWRpYVN0cmVhbT17cmVtb3RlTWVkaWFTdHJlYW19IC8+XG5cbiAgICAgICAgPEZvcm1cbiAgICAgICAgICBoYW5kbGVTdWJtaXQ9e3RoaXMuaGFuZGxlU3VibWl0fVxuICAgICAgICAgIGhhbmRsZUNoYW5nZT17dGhpcy5oYW5kbGVDaGFuZ2V9XG4gICAgICAgICAgaGFzUm9vbUtleT17cm9vbUtleX1cbiAgICAgICAgICB0ZXh0PXt0ZXh0fVxuICAgICAgICAvPlxuXG4gICAgICAgIDxzZWN0aW9uIGNsYXNzTmFtZT0nYnV0dG9uLWNvbnRhaW5lcic+XG4gICAgICAgICAgPGRpdiBjbGFzc05hbWU9J2J1dHRvbiBidXR0b24tLXN0YXJ0LWNvbG9yJyBvbkNsaWNrPXt0aGlzLm9wZW5DYW1lcmF9PlxuICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgIDxidXR0b24gb25DbGljaz17dGhpcy5oYW5kbGVTaGFyZURpc3BsYXl9PlNoYXJlIFNjcmVlbjwvYnV0dG9uPlxuICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSdidXR0b24gYnV0dG9uLS1zdG9wLWNvbG9yJyBvbkNsaWNrPXtudWxsfT5cbiAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgPC9zZWN0aW9uPlxuICAgICAgPC8+XG4gICAgKTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBSVENNZXNoO1xuIl19